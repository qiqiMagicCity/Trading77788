
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>交易分析 - Trading777</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="js/equityCurve.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <!-- Top Nav -->
  <nav class="bg-slate-800 py-3 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
      <h1 class="text-xl font-bold tracking-wide">Trading777 · 交易分析</h1>
      <a href="index.html" class="text-sm text-blue-400 hover:underline">← 返回仪表盘</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 space-y-14">
    <!-- 功能区 1: 资金收益图表 -->
    <section id="pnlChartSection">
      <h2 class="text-lg font-semibold mb-4">资金收益曲线</h2>
      <canvas id="pnlChart" class="w-full h-72 bg-slate-800 rounded-xl p-4"></canvas>
    </section>

    <!-- 功能区 2: 交易日历 -->
    <section id="calendarSection">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">交易日历</h2>
        <div>
          <button id="toggleAbs" class="px-3 py-1 text-xs rounded-l-lg bg-blue-500">绝对值</button>
          <button id="togglePct" class="px-3 py-1 text-xs rounded-r-lg bg-slate-700">收益率%</button>
        </div>
      </div>
      <div id="calendar" class="bg-slate-800 rounded-xl p-4"></div>
    </section>

    <!-- 功能区 3: 盈亏排行榜 -->
    <section id="rankingSection">
      <h2 class="text-lg font-semibold mb-4">盈亏排行榜</h2>
      <div class="flex mb-4">
        <button id="profitTab" class="flex-1 py-2 bg-blue-500 rounded-l-lg text-sm">盈利 TOP 10</button>
        <button id="lossTab" class="flex-1 py-2 bg-slate-700 rounded-r-lg text-sm">亏损 TOP 10</button>
      </div>
      <div class="bg-slate-800 rounded-xl overflow-x-auto">
        <table id="rankingTable" class="w-full text-sm text-left">
          <thead class="uppercase tracking-wider text-slate-400 text-xs border-b border-slate-700">
            <tr><th>排名</th><th>代码</th><th>中文</th><th>累计盈亏 ($)</th></tr>
          </thead>
          <tbody class="text-slate-300">
            <!-- 动态填充 -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

<script>
// === 资金收益曲线渲染 ===
(function(){
  const canvas = document.getElementById('pnlChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const curve = loadCurve();
  const labels = curve.map(p=>p.date);
  const data = curve.map(p=>p.cumulative);
  if(labels.length===0) return;
  new Chart(ctx,{
    type:'line',
    data:{labels, datasets:[{label:'累计净值变化', data, tension:0.25, fill:true}]},
    options:{scales:{y:{beginAtZero:true}}, plugins:{legend:{display:false}}}
  });
})();


// dummy trades data
const trades = [
  {date: '2025-05-01', symbol: 'TSLA', side:'SELL', qty:10, price:300},
  {date: '2025-05-02', symbol: 'AAPL', side:'BUY', qty:50, price:200},
  {date: '2025-05-05', symbol: 'TSLA', side:'BUY', qty:5, price:310},
  {date: '2025-05-05', symbol: 'AMD', side:'SELL', qty:100, price:120},
  {date: '2025-05-07', symbol: 'GOOGL', side:'BUY', qty:10, price:180},
  {date: '2025-05-22', symbol: 'GOOGL', side:'SELL', qty:5, price:190},
];

// Helper to group by date sum pnl
function calcDailyPnl() {
  const daily = {};
  trades.forEach(t=>{
    const amt = (t.side==='SELL'?1:-1)*t.qty*t.price;
    daily[t.date]=(daily[t.date]||0)+amt;
  });
  return daily;
}

// Chart
const dailyPnl = calcDailyPnl();
const labels = Object.keys(dailyPnl).sort();
const data = labels.map(d=>dailyPnl[d]);

const ctx = document.getElementById('pnlChart');
new Chart(ctx, {
  type:'line',
  data:{
    labels,
    datasets:[{
      label:'净收益 ($)',
      data,
      fill:false,
    }]
  },
  options:{
    responsive:true,
    scales:{
      x:{ticks:{color:'#94a3b8'}},
      y:{ticks:{color:'#94a3b8'}}
    },
    plugins:{
      legend:{display:false},
      tooltip:{callbacks:{label:(c)=>` $${c.parsed.y.toFixed(2)}`}}
    }
  }
});

// Calendar
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const events = labels.map(d=>({
    title:`${dailyPnl[d]>0?'+':''}${dailyPnl[d].toFixed(2)}`,
    start:d,
    color: dailyPnl[d]>0 ? '#22c55e' : '#ef4444'
  }));
  const cal = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    events
  });
  cal.render();
});

// Ranking
function renderRanking(type='profit') {
  const symPnl = {};
  trades.forEach(t=>{
    const amt = (t.side==='SELL'?1:-1)*t.qty*t.price;
    symPnl[t.symbol]=(symPnl[t.symbol]||0)+amt;
  });
  let rows = Object.entries(symPnl).map(([s,p])=>({symbol:s,pnl:p}));
  rows.sort((a,b)=> type==='profit'? b.pnl-a.pnl : a.pnl-b.pnl);
  rows = rows.slice(0,10);
  const tbody = document.querySelector('#rankingTable tbody');
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="py-1 px-2">${i+1}</td><td class="py-1 px-2">${r.symbol}</td><td class="py-1 px-2">--</td><td class="py-1 px-2 ${r.pnl>=0?'text-green-400':'text-red-400'}">${r.pnl.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}
renderRanking('profit');

document.getElementById('profitTab').addEventListener('click', ()=>{
  document.getElementById('profitTab').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('lossTab').classList.replace('bg-blue-500','bg-slate-700');
  renderRanking('profit');
});
document.getElementById('lossTab').addEventListener('click', ()=>{
  document.getElementById('lossTab').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('profitTab').classList.replace('bg-blue-500','bg-slate-700');
  renderRanking('loss');
});
</script>
</body>
</html>