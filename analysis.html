
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>交易分析 - Trading777 v7.7.13</title>
  <script defer src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script defer src="js/analysis.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <!-- Top Nav -->
  <nav class="bg-slate-800 py-3 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
      <h1 class="text-xl font-bold tracking-wide">Trading777 · 交易分析</h1>
      <a href="index.html" class="text-sm text-blue-400 hover:underline">← 返回仪表盘</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 space-y-14">
    <!-- 功能区 1: 资金收益图表 -->
    <section id="pnlChartSection">
      <h2 class="text-lg font-semibold mb-4">资金收益曲线</h2>
      
<div class="flex gap-1 mb-2">
  <button data-gran="day" id="granDay" class="px-3 py-1 text-xs rounded-l-lg bg-blue-500">日</button>
  <button data-gran="week" id="granWeek" class="px-3 py-1 text-xs bg-slate-700">周</button>
  <button data-gran="month" id="granMonth" class="px-3 py-1 text-xs rounded-r-lg bg-slate-700">月</button>
</div>
<canvas id="pnlChart" class="w-full h-72 bg-slate-800 rounded-xl p-4"></canvas>
    </section>

    <!-- 功能区 2: 交易日历 -->
    
<!-- 功能区 2: 交易日历（总账户） -->
<section id="totalCalendarSection">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold">交易日历（总账户）</h2>
    <div>
      <button id="toggleAbsTotal" class="px-3 py-1 text-xs rounded-l-lg bg-blue-500">绝对值</button>
      <button id="togglePctTotal" class="px-3 py-1 text-xs rounded-r-lg bg-slate-700">收益率%</button>
    </div>
  </div>
  <div id="totalCalendar" class="bg-slate-800 rounded-xl p-4"></div>
</section>
<section id="intraCalendarSection">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">交易日历（日内交易）</h2>
        <div>
          <button id="toggleAbsIntra" class="px-3 py-1 text-xs rounded-l-lg bg-blue-500">绝对值</button>
          <button id="togglePctIntra" class="px-3 py-1 text-xs rounded-r-lg bg-slate-700">收益率%</button>
        </div>
      </div>
      <div id="intraCalendar" class="bg-slate-800 rounded-xl p-4"></div>
    </section>

    <!-- 功能区 3: 盈亏排行榜 -->
    <section id="rankingSection">
      <h2 class="text-lg font-semibold mb-4">盈亏排行榜</h2>
      <div class="flex mb-4">
        <button id="profitTab" class="flex-1 py-2 bg-blue-500 rounded-l-lg text-sm">盈利 TOP 10</button>
        <button id="lossTab" class="flex-1 py-2 bg-slate-700 rounded-r-lg text-sm">亏损 TOP 10</button>
      </div>
      <div class="bg-slate-800 rounded-xl overflow-x-auto">
        <table id="rankingTable" class="w-full text-sm text-left">
          <thead class="uppercase tracking-wider text-slate-400 text-xs border-b border-slate-700">
            <tr><th>排名</th><th>logo</th><th>代码</th><th>中文</th><th>累计盈亏 ($)</th></tr>
          </thead>
          <tbody class="text-slate-300">
            <!-- 动态填充 -->
          </tbody>
        </table>
      </div>
    </section>
  </main>


<script>
// ----------------- Data Load -----------------
const trades = JSON.parse(localStorage.getItem('trades') || '[]');

// helpers
function tradePnl(t){
  if (typeof t.pl === 'number' && !isNaN(t.pl)) return t.pl;
  const sign = (t.side === 'SELL' || t.side === 'COVER') ? 1 : -1;
  return sign * t.qty * t.price;
}
function groupBy(arr, keyFn){
  const m = {};
  arr.forEach(it=>{
    const k = keyFn(it);
    (m[k] = m[k] || []).push(it);
  });
  return m;
}

// ----------------- Capital Curve -----------------
const granBtns = {
  day: document.getElementById('granDay'),
  week: document.getElementById('granWeek'),
  month: document.getElementById('granMonth')
};
let granularity = 'day';
const pnlCtx = document.getElementById('pnlChart').getContext('2d');
let pnlChart;

function labelForGran(date, gran){
  const d = new Date(date);
  if(gran === 'week'){
    const year = d.getFullYear();
    const firstJan = new Date(year,0,1);
    const week = Math.ceil((((d - firstJan)/86400000) + firstJan.getDay()+1)/7);
    return `${year}-W${week}`;
  }
  if(gran === 'month'){
    return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
  }
  return d.toISOString().slice(0,10);
}

function buildCurveData(gran){
  const grouped = groupBy(trades, t=>labelForGran(t.date, gran));
  const labels = Object.keys(grouped).sort();
  let cumulative = 0;
  const data = labels.map(l=>{
    const periodPnl = grouped[l].reduce((s,t)=>s+tradePnl(t),0);
    cumulative += periodPnl;
    return cumulative;
  });
  return {labels,data};
}

function renderCurve(){
  const {labels,data} = buildCurveData(granularity);
  if(pnlChart) pnlChart.destroy();
  pnlChart = new Chart(pnlCtx,{
    type:'line',
    data:{labels,datasets:[{data, borderWidth:2,tension:.3}]},
    options:{
      responsive:true,
      scales:{x:{grid:{display:false},ticks:{color:'#cbd5e1'}},
              y:{grid:{display:false},ticks:{color:'#cbd5e1'}}},
      plugins:{legend:{display:false}}
    }
  });
}
Object.entries(granBtns).forEach(([gran,btn])=>{
  btn.addEventListener('click', ()=>{
    granularity = gran;
    Object.values(granBtns).forEach(b=>b.classList.replace('bg-blue-500','bg-slate-700'));
    btn.classList.replace('bg-slate-700','bg-blue-500');
    renderCurve();
  });
});
renderCurve();

// ----------------- Trading Calendar -----------------
const dailyGrouped = groupBy(trades, t=>t.date);
const dailyAbs = {};
const dailyPct = {};
Object.entries(dailyGrouped).forEach(([date, arr])=>{
  const abs = arr.reduce((s,t)=>s+tradePnl(t),0);
  const gross = arr.reduce((s,t)=>s+t.qty*t.price,0) || 1;
  const pct = abs / gross * 100;
  dailyAbs[date] = abs;
  dailyPct[date] = pct;
});
const calendarEl = document.getElementById('intraCalendar');
let showPct = false;
let calendar;

function buildEvents(){
  return Object.keys(dailyAbs).sort().map(d=>{
    const val = showPct ? dailyPct[d] : dailyAbs[d];
    const title = showPct ? `${val>=0?'+':''}${val.toFixed(2)}%` : `${val>=0?'+':''}${val.toFixed(2)}`;
    return {title,start:d,color: val>=0 ? '#22c55e' : '#ef4444'};
  });
}

function renderCalendar(){
  if(calendar) calendar.destroy();
  calendar = new FullCalendar.Calendar(calendarEl,{firstDay:1,
    initialView:'dayGridMonth',
    height:'auto',
    events: buildEvents()
  });
  calendar.render();
}
renderCalendar();

document.getElementById('toggleAbsIntra').addEventListener('click', ()=>{
  showPct=false;
  document.getElementById('toggleAbsIntra').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('togglePctIntra').classList.replace('bg-blue-500','bg-slate-700');
  renderCalendar();
});
document.getElementById('togglePctIntra').addEventListener('click', ()=>{
  showPct=true;
  document.getElementById('togglePctIntra').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('toggleAbsIntra').classList.replace('bg-blue-500','bg-slate-700');
  renderCalendar();
});

// Remove FullCalendar grid borders via CSS injection
const style = document.createElement('style');
style.textContent = `
  .fc-theme-standard .fc-scrollgrid,
  .fc-theme-standard td,
  .fc-theme-standard th { border:none !important;}
  .fc-col-header-cell-cushion { color:#cbd5e1; }
  .fc-col-header-cell { background-color:#0f172a !important; }
  .fc-day-other, .fc-day-sat, .fc-day-sun { background-color:transparent !important; }
`;
document.head.appendChild(style);

// ----------------- P/L Ranking -----------------
function buildRanking(){
  const symMap = {};
  trades.forEach(t=>{
    const p = tradePnl(t);
    symMap[t.symbol] = (symMap[t.symbol] || 0) + p;
  });
  const arr = Object.entries(symMap).map(([symbol,pnl])=>({symbol,pnl}));
  const profitTop = arr.filter(i=>i.pnl>0).sort((a,b)=>b.pnl-a.pnl).slice(0,10);
  const lossTop   = arr.filter(i=>i.pnl<0).sort((a,b)=>a.pnl-b.pnl).slice(0,10);
  return {profitTop, lossTop};
}
const tbody = document.querySelector('#rankingTable tbody');
function renderRanking(type='profit'){
  const {profitTop,lossTop} = buildRanking();
  const list = type==='profit'?profitTop:lossTop;
  tbody.innerHTML='';
  list.forEach((row,i)=>{
    const cn = window.SymbolCN && window.SymbolCN[row.symbol] ? window.SymbolCN[row.symbol] : '';
    tbody.insertAdjacentHTML('beforeend',`
      <tr class="border-b border-slate-700">
        <td class="py-1 px-2">${i+1}</td>
        <td class="py-1 px-2"><img loading="lazy" src="logos/${row.symbol}.png" alt="${row.symbol}" onerror="this.style.visibility='hidden';" class="w-5 h-5 inline-block"></td>
        <td class="py-1 px-2">${row.symbol}</td>
        <td class="py-1 px-2">${cn}</td>
        <td class="py-1 px-2 ${row.pnl>=0?'text-green-400':'text-red-400'}">${row.pnl.toFixed(2)}</td>
      </tr>
    `);
  });
}
renderRanking('profit');
document.getElementById('profitTab').addEventListener('click', ()=>{
  document.getElementById('profitTab').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('lossTab').classList.replace('bg-blue-500','bg-slate-700');
  renderRanking('profit');
});
document.getElementById('lossTab').addEventListener('click', ()=>{
  document.getElementById('lossTab').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('profitTab').classList.replace('bg-blue-500','bg-slate-700');
  renderRanking('loss');
});

/* === Total Account Calendar === */
const dailyAbsIntra = (window.Calendars && window.Calendars.intraday) ? window.Calendars.intraday : dailyAbs; // reuse intraday abs
// Build total account pct relative to previous cumulative profit
const sortedDates = Object.keys(dailyAbsIntra).sort();
const dailyPctTotal = {};
let cumulativePrev = 0;
sortedDates.forEach(date=>{
  const abs = dailyAbsIntra[date];
  dailyPctTotal[date] = cumulativePrev === 0 ? 0 : abs / cumulativePrev * 100;
  cumulativePrev += abs;
});
const dailyAbsTotal = (window.Calendars && window.Calendars.total) ? window.Calendars.total : {};

const totalCalendarEl = document.getElementById('totalCalendar');
let showPctTotalFlag = false;
let totalCalendar;
function buildEventsTotal(){
  return sortedDates.map(d=>{
    const val = showPctTotalFlag ? dailyPctTotal[d] : dailyAbsTotal[d];
    const title = showPctTotalFlag ? `${val>=0?'+':''}${val.toFixed(2)}%` : `${val>=0?'+':''}${val.toFixed(2)}`;
    return {title,start:d,color: val>=0 ? '#22c55e' : '#ef4444'};
  });
}
function renderTotalCalendar(){
  if(totalCalendar) totalCalendar.destroy();
  totalCalendar = new FullCalendar.Calendar(totalCalendarEl,{firstDay:1,
    initialView:'dayGridMonth',
    height:'auto',
    events: buildEventsTotal()
  });
  totalCalendar.render();
}
renderTotalCalendar();
document.getElementById('toggleAbsTotal').addEventListener('click', ()=>{
  showPctTotalFlag=false;
  document.getElementById('toggleAbsTotal').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('togglePctTotal').classList.replace('bg-blue-500','bg-slate-700');
  renderTotalCalendar();
});
document.getElementById('togglePctTotal').addEventListener('click', ()=>{
  showPctTotalFlag=true;
  document.getElementById('togglePctTotal').classList.replace('bg-slate-700','bg-blue-500');
  document.getElementById('toggleAbsTotal').classList.replace('bg-blue-500','bg-slate-700');
  renderTotalCalendar();
});
</script>

</body>
</html>
